# 🧅 Настройка Tor для AntiZapret

Подробное руководство по настройке Tor с транспортными плагинами obfs4 и webtunnel для обхода блокировок.

---

## 📋 Содержание

- [Обзор](#-обзор)
- [Архитектура](#-архитектура)
- [Установка](#-установка)
- [Настройка мостов](#-настройка-мостов)
- [Конфигурация torrc](#-конфигурация-torrc)
- [Транспортные плагины](#-транспортные-плагины)
- [Оптимизация](#-оптимизация)
- [Мониторинг](#-мониторинг)
- [Решение проблем](#-решение-проблем)
- [Безопасность](#-безопасность)

---

## 🌐 Обзор

### Что такое Tor?

**Tor** (The Onion Router) — это сеть для анонимизации интернет-трафика. В контексте AntiZapret мы используем Tor как прозрачный прокси для обхода блокировок.

### Преимущества использования Tor

| Преимущество | Описание |
|--------------|----------|
| 🔒 **Анонимность** | Ваш реальный IP скрыт от целевых сайтов |
| 🌍 **Децентрализация** | Нет единой точки отказа |
| 🆓 **Бесплатность** | Не требует платных VPN-сервисов |
| 🔧 **Надёжность** | Работает даже при частичных блокировках |
| 🛡️ **Устойчивость** | Мосты позволяют обойти блокировку самого Tor |

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         AntiZapret + Tor                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────┐    ┌───────────────┐    ┌──────────┐    ┌─────────────┐  │
│  │ Клиент   │───▶│  OPNsense     │───▶│   Tor    │───▶│  Интернет   │  │
│  │          │    │  NAT + Alias  │    │  Proxy   │    │             │  │
│  └──────────┘    └───────────────┘    └──────────┘    └─────────────┘  │
│                                                                         │
│  Компоненты Tor:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  ● TransPort (9040) — прозрачный прокси для TCP                 │   │
│  │  ● SocksPort (9050) — SOCKS5 прокси                             │   │
│  │  ● DNSPort (9053)   — DNS резолвер через Tor                    │   │
│  │  ● obfs4proxy       — маскировка под случайный трафик           │   │
│  │  ● webtunnel        — маскировка под HTTPS                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 🏗️ Архитектура

### Как работает прозрачный прокси

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Поток трафика                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. Клиент запрашивает blocked-site.com                                │
│      │                                                                  │
│      ▼                                                                  │
│   2. DNS-запрос → OPNsense → (не через Tor для обычных сайтов)         │
│      │                                                                  │
│      ▼                                                                  │
│   3. IP-адрес сайта определён: 1.2.3.4                                 │
│      │                                                                  │
│      ▼                                                                  │
│   4. OPNsense проверяет: 1.2.3.4 ∈ AntiZapret_IPs?                     │
│      │                                                                  │
│      ├── НЕТ → прямое подключение к сайту                              │
│      │                                                                  │
│      └── ДА → NAT redirect на 127.0.0.1:9040 (Tor TransPort)           │
│               │                                                         │
│               ▼                                                         │
│   5. Tor создаёт цепочку из 3 узлов                                    │
│      │                                                                  │
│      ▼                                                                  │
│   6. Трафик выходит через exit-ноду в другой стране                    │
│      │                                                                  │
│      ▼                                                                  │
│   7. Сайт отвечает, данные идут обратно через Tor                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Порты и их назначение

| Порт | Протокол | Назначение | Доступ |
|------|----------|------------|--------|
| **9040** | TCP | Transparent Proxy | Только localhost |
| **9050** | TCP | SOCKS5 Proxy | LAN + localhost |
| **9053** | UDP/TCP | DNS over Tor | LAN + localhost |

---

## 📦 Установка

### Автоматическая установка

Используйте основной установщик AntiZapret:

```bash
cd /root/antizapret
./install.sh
```

### Ручная установка пакетов

```bash
# Основной пакет Tor
pkg install -y tor

# Транспортные плагины
pkg install -y obfs4proxy-tor    # obfs4 транспорт
pkg install -y webtunnel-tor     # webtunnel транспорт

# Проверка установки
pkg info | grep -E "tor|obfs4|webtunnel"
```

### Проверка бинарных файлов

```bash
# Tor
which tor
/usr/local/bin/tor

# obfs4proxy
which obfs4proxy
/usr/local/bin/obfs4proxy

# webtunnel
which webtunnel-tor-client
/usr/local/bin/webtunnel-tor-client

# Версии
tor --version
obfs4proxy -version
```

---

## 🌉 Настройка мостов

### Когда нужны мосты?

Мосты необходимы, если:

- ❌ Прямые подключения к Tor заблокированы
- ❌ Провайдер использует DPI для блокировки Tor
- ❌ Вы находитесь в стране с жёсткой цензурой

### Типы мостов

| Тип | Описание | Когда использовать |
|-----|----------|-------------------|
| **obfs4** | Маскирует трафик под случайные данные | Базовая блокировка Tor |
| **webtunnel** | Маскирует трафик под HTTPS | DPI блокирует obfs4 |
| **snowflake** | Использует WebRTC | Заблокированы другие мосты |
| **meek** | Использует CDN (Azure/Amazon) | Крайний случай |

### Получение мостов

#### Способ 1: Веб-сайт

1. Перейдите на https://bridges.torproject.org/
2. Выберите тип транспорта
3. Решите CAPTCHA
4. Скопируйте bridge-строки

#### Способ 2: Email

1. Отправьте email на `bridges@torproject.org`
2. Тема: `get transport obfs4` (или `webtunnel`)
3. Используйте Gmail, Yahoo или Riseup
4. Получите мосты в ответном письме

#### Способ 3: Telegram

1. Найдите бота [@GetBridgesBot](https://t.me/GetBridgesBot)
2. Отправьте команду `/bridges`
3. Выберите тип транспорта
4. Получите мосты

### Формат bridge-строк

#### obfs4

```
Bridge obfs4 IP:PORT FINGERPRINT cert=CERTIFICATE iat-mode=0
```

Пример:
```
Bridge obfs4 192.0.2.1:443 1234567890ABCDEF1234567890ABCDEF12345678 cert=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/ABC iat-mode=0
```

#### webtunnel

```
Bridge webtunnel IP:PORT FINGERPRINT url=https://domain.com/path ver=0.0.1
```

Пример:
```
Bridge webtunnel 192.0.2.2:443 ABCDEF1234567890ABCDEF1234567890ABCDEF12 url=https://example.com/tor/ ver=0.0.1
```

---

## 📝 Конфигурация torrc

### Расположение файла

```
/usr/local/etc/tor/torrc
```

### Полный пример конфигурации

```ini
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║                    AntiZapret TOR Configuration                           ║
# ║                      for OPNsense / FreeBSD                               ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

# ─────────────────────────────────────────────────────────────────────────────
# LOGGING
# ─────────────────────────────────────────────────────────────────────────────

# Уровни: debug, info, notice, warn, err
Log notice file /var/log/tor/notices.log

# Для отладки (раскомменти��уйте при необходимости):
# Log info file /var/log/tor/info.log
# Log debug file /var/log/tor/debug.log

# ─────────────────────────────────────────────────────────────────────────────
# DATA DIRECTORY
# ─────────────────────────────────────────────────────────────────────────────

DataDirectory /var/db/tor
PidFile /var/run/tor/tor.pid

# ─────────────────────────────────────────────────────────────────────────────
# NETWORK PORTS
# ─────────────────────────────────────────────────────────────────────────────

# SOCKS5 прокси
SocksPort 127.0.0.1:9050                    # Локальный доступ
SocksPort 192.168.1.1:9050                  # Доступ из LAN

# DNS через Tor
DNSPort 127.0.0.1:9053
DNSPort 192.168.1.1:9053

# Прозрачный прокси для AntiZapret
TransPort 9040

# ─────────────────────────────────────────────────────────────────────────────
# VIRTUAL ADDRESS MAPPING
# ─────────────────────────────────────────────────────────────────────────────

# Диапазон для .onion адресов
VirtualAddrNetworkIPv4 10.192.0.0/10
AutomapHostsOnResolve 1

# ─────────────────────────────────────────────────────────────────────────────
# DAEMON MODE
# ─────────────────────────────────────────────────────────────────────────────

RunAsDaemon 1
User _tor

# ─────────────────────────────────────────────────────────────────────────────
# EXIT POLICY (Client-only mode)
# ─────────────────────────────────────────────────────────────────────────────

# Мы НЕ являемся relay/exit-нодой
ExitPolicy reject *:*
ExitPolicy reject6 *:*
ExitRelay 0

# ─────────────────────────────────────────────────────────────────────────────
# NODE SELECTION
# ─────────────────────────────────────────────────────────────────────────────

# Исключаем узлы из СНГ и соседних стран
ExcludeNodes {RU},{BY},{KG},{KZ},{UZ},{TJ},{TM},{TR},{AZ},{AM},{GE},{MD},{UA}
ExcludeExitNodes {RU},{BY},{KG},{KZ},{UZ},{TJ},{TM},{TR},{AZ},{AM},{GE},{MD},{UA}

# Принудительное соблюдение ограничений
StrictNodes 1

# Предпочитаемые страны для exit-нод (опционально)
# ExitNodes {NL},{DE},{SE},{CH},{NO},{FI}

# ─────────────────────────────────────────────────────────────────────────────
# IPv6 CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────

ClientUseIPv6 1
ClientUseIPv4 1
ClientPreferIPv6ORPort 1

# ─────────────────────────────────────────────────────────────────────────────
# TRANSPORT PLUGINS
# ─────────────────────────────────────────────────────────────────────────────

ClientTransportPlugin obfs4 exec /usr/local/bin/obfs4proxy managed
ClientTransportPlugin webtunnel exec /usr/local/bin/webtunnel-tor-client

# ─────────────────────────────────────────────────────────────────────────────
# BRIDGE CONFIGURATION
# ─────────────────────────────────────────────────────────────────────────────

# Включить использование мостов (0 = выкл, 1 = вкл)
UseBridges 0

# Примеры мостов (раскомментируйте и замените на свои):
#
# obfs4:
# Bridge obfs4 192.0.2.1:443 FINGERPRINT cert=CERT iat-mode=0
# Bridge obfs4 192.0.2.2:9001 FINGERPRINT cert=CERT iat-mode=0
#
# webtunnel:
# Bridge webtunnel 192.0.2.3:443 FINGERPRINT url=https://example.com/

# ─────────────────────────────────────────────────────────────────────────────
# PERFORMANCE & MISC
# ─────────────────────────────────────────────────────────────────────────────

# Отчёт о состоянии каждый час
HeartbeatPeriod 1 hours

# Таймауты для цепочек
CircuitBuildTimeout 30
LearnCircuitBuildTimeout 1

# Количество guard-нод
NumEntryGuards 3

# Кэширование
MaxMemInQueues 256 MB
```

### Проверка конфигурации

```bash
# Проверка синтаксиса
tor --verify-config

# Ожидаемый вывод
Configuration was valid
```

---

## 🔌 Транспортные плагины

### obfs4 (Recommended)

**obfs4** — наиболее распространённый pluggable transport для обхода DPI.

#### Как это работает

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         obfs4 транспорт                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Клиент                    obfs4proxy                 Мост             │
│  ┌───────┐                 ┌─────────┐              ┌───────┐          │
│  │  Tor  │ ──Tor traffic──▶│ obfs4   │ ──Random──▶ │ obfs4 │ ──▶ Tor  │
│  │Client │                 │ proxy   │   bytes     │ bridge│     Net  │
│  └───────┘                 └─────────┘              └───────┘          │
│                                                                         │
│  Для DPI это выглядит как случайные данные,                            │
│  не имеющие характерных признаков Tor                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Преимущества

- ✅ Высокая скорость
- ✅ Низкие накладные расходы
- ✅ Сложно детектировать
- ✅ Широко поддерживается

#### Настройка

```ini
ClientTransportPlugin obfs4 exec /usr/local/bin/obfs4proxy managed
UseBridges 1
Bridge obfs4 IP:PORT FINGERPRINT cert=CERT iat-mode=0
```

### webtunnel

**webtunnel** — маскирует Tor-трафик под обычный HTTPS.

#### Как это работает

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       webtunnel транспорт                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Клиент                   webtunnel                   Сервер           │
│  ┌───────┐                ┌─────────┐              ┌───────────┐       │
│  │  Tor  │ ──Tor data──▶  │webtunnel│ ──HTTPS──▶  │ HTTPS     │       │
│  │Client │                │ client  │   traffic   │ + bridge  │ ──▶Tor│
│  └───────┘                └─────────┘              └───────────┘       │
│                                                                         │
│  Трафик выглядит как обычный HTTPS к веб-сайту                         │
│  Даже URL выглядит легитимно: https://example.com/                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### Преимущества

- ✅ Выглядит как обычный HTTPS
- ✅ Работает даже при блокировке obfs4
- ✅ Использует стандартный порт 443
- ✅ Сложнее заблокировать без побочных эффектов

#### Настройка

```ini
ClientTransportPlugin webtunnel exec /usr/local/bin/webtunnel-tor-client
UseBridges 1
Bridge webtunnel IP:PORT FINGERPRINT url=https://example.com/path
```

### Сравнение транспортов

| Характеристика | obfs4 | webtunnel |
|----------------|-------|-----------|
| **Скорость** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **Скрытность** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Доступность мостов** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **Устойчивость к DPI** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Простота настройки** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## ⚡ Оптимизация

### Оптимизация производительности

```ini
# Увеличение памяти для очередей
MaxMemInQueues 512 MB

# Ускорение построения цепочек
CircuitBuildTimeout 20
LearnCircuitBuildTimeout 1

# Больше параллельных цепочек
MaxCircuitDirtiness 600

# Предзагрузка цепочек
__DisablePredictedCircuits 0
```

### Оптимизация для стабильности

```ini
# Увеличенные таймауты
CircuitBuildTimeout 60
SocksTimeout 120

# Больше guard-нод для резервирования
NumEntryGuards 5

# Повторные попытки подключения
ConnectionPadding auto
ReducedConnectionPadding 0
```

### Оптимизация для анонимности

```ini
# Частая смена цепочек
MaxCircuitDirtiness 300

# Изоляция по портам
IsolateDestPort
IsolateDestAddr

# Отключение опасных функций
SafeSocks 1
TestSocks 1
```

---

## 📊 Мониторинг

### Просмотр логов

```bash
# Текущие логи
tail -f /var/log/tor/notices.log

# Последние 100 строк
tail -100 /var/log/tor/notices.log

# Поиск ошибок
grep -i "error\|warn\|err" /var/log/tor/notices.log

# Статус загрузки
grep "Bootstrapped" /var/log/tor/notices.log
```

### Стадии загрузки (Bootstrap)

| Процент | Стадия | Описание |
|---------|--------|----------|
| 0% | Starting | Запуск Tor |
| 5% | Connecting to directory | Подключение к каталогу |
| 10% | Handshaking with directory | Рукопожатие с каталогом |
| 15% | Establishing circuit | Установка цепочки |
| 20% | Asking for networkstatus | Запрос статуса сети |
| 25% | Loading networkstatus | Загрузка статуса сети |
| 40% | Loading authority certificates | Загрузка сертификатов |
| 45% | Asking for relay descriptors | Запрос дескрипторов |
| 50-80% | Loading relay descriptors | Загрузка дескрипторов |
| 85% | Connecting to network | Подключение к сети |
| 90% | Establishing circuit | Установка первой цепочки |
| 100% | Done | Готово к работе |

### Проверка статуса

```bash
# Статус сервиса
service tor status

# Информация о процессе
ps aux | grep tor

# Используемые порты
sockstat -4l | grep tor

# Использование памяти
ps -o rss,vsz,command -p $(pgrep -x tor)
```

### Проверка соединения

```bash
# Проверка через SOCKS-прокси
curl --socks5 127.0.0.1:9050 https://check.torproject.org/api/ip

# Проверка exit-ноды
curl --socks5 127.0.0.1:9050 https://ipinfo.io/json

# Проверка DNS через Tor
dig @127.0.0.1 -p 9053 example.com
```

---

## 🔧 Решение проблем

### Tor не запускается

#### Проверка 1: Синтаксис конфигурации

```bash
tor --verify-config
```

#### Проверка 2: Права доступа

```bash
ls -la /var/log/tor/
ls -la /var/run/tor/
ls -la /var/db/tor/

# Исправление
chown -R _tor:_tor /var/log/tor /var/run/tor /var/db/tor
chmod 700 /var/db/tor
```

#### Проверка 3: Порты

```bash
sockstat -4l | grep -E "9040|9050|9053"
```

Если порты заняты — найдите и остановите конфликтующий процесс.

### Tor не подключается (застрял на Bootstrap)

#### Симптомы и решения

| Симптом | Возможная причина | Решение |
|---------|-------------------|---------|
| Застрял на 5% | Нет интернета | Проверьте сеть |
| Застрял на 10% | Заблокирован Tor | Настройте мосты |
| Застрял на 15% | Firewall блокирует | Проверьте правила |
| Застрял на 50% | Медленная сеть | Увеличьте таймауты |

#### Включение мостов

```bash
# Редактирование конфигурации
nano /usr/local/etc/tor/torrc

# Измените:
UseBridges 1

# Добавьте мосты:
Bridge obfs4 ...

# Перезапуск
service tor restart
```

### Низкая скорость

#### Проверка текущей цепочки

```bash
# Информация о цепочках (требует ControlPort)
# Добавьте в torrc:
ControlPort 9051
CookieAuthentication 1
```

#### Оптимизация

```ini
# В torrc:
CircuitBuildTimeout 15
LearnCircuitBuildTimeout 0
MaxCircuitDirtiness 300
```

### Сайты не открываются через прокси

#### Чеклист

```bash
# 1. Tor запущен?
service tor status

# 2. Tor подключён?
grep "Bootstrapped 100%" /var/log/tor/notices.log

# 3. Порты слушают?
sockstat -4l | grep tor

# 4. NAT правило работает?
# Проверьте в OPNsense: Firewall → NAT → Port Forward

# 5. Alias содержит IP?
pfctl -t AntiZapret_IPs -T show | head

# 6. IP сайта в списке?
host blocked-site.com
grep "ПОЛУЧЕННЫЙ_IP" /usr/local/www/ipfw_antizapret.dat
```

---

## 🛡️ Безопасность

### Рекомендации по безопасности

#### ✅ Делайте

- Регулярно обновляйте Tor
- Используйте мосты в странах с цензурой
- Исключайте узлы из СНГ
- Мониторьте логи на предмет аномалий

#### ❌ Не делайте

- Не используйте как exit-ноду
- Не открывайте ControlPort в сеть
- Не отключайте StrictNodes
- Не используйте устаревшие версии Tor

### Что видит провайдер

| Режим | Что видит провайдер |
|-------|---------------------|
| **Без мостов** | Подключения к известным Tor-нодам |
| **obfs4** | Зашифрованный трафик на нестандартные IP |
| **webtunnel** | HTTPS-трафик к обычному веб-сайту |

### Что видит целевой сайт

| Информация | Видит? |
|------------|--------|
| Ваш реальный IP | ❌ Нет |
| IP exit-ноды | ✅ Да |
| Что вы используете Tor | ✅ Да (можно определить) |
| Содержимое трафика (HTTPS) | ❌ Нет |

---

## 📚 Дополнительные ресурсы

### Официальные ресурсы

| Ресурс | URL |
|--------|-----|
| Tor Project | https://www.torproject.org/ |
| Tor Manual | https://2019.www.torproject.org/docs/tor-manual.html |
| Bridge DB | https://bridges.torproject.org/ |
| Tor Metrics | https://metrics.torproject.org/ |

### Связанная документация

| Документ | Описание |
|----------|----------|
| [README.md](README.md) | Общее описание проекта |
| [INSTALL.md](INSTALL.md) | Полная инструкция по установке |
| [WireGuard.md](WireGuard.md) | Альтернатива с WireGuard |
| [FAQ.md](FAQ.md) | Часто задаваемые вопросы |

---

## 💖 Поддержать проект

Если AntiZapret оказался полезен:

<div align="center">

**USDT (TRC20)**

```
TCyZuUjX3ymFmrDPxTmeSNPMuuWRDtviFy
```

</div>

---

<div align="center">

Основано на [Limych/antizapret](https://github.com/Limych/antizapret)

**[⬆ Вернуться наверх](#-настройка-tor-для-antizapret)**

</div>
