name: "Release"

on:
  push:
    tags:
      - 'v*'
    branches:
      - master

jobs:
  release_zip_file:
    name: "Prepare release asset"
    runs-on: ubuntu-latest
    steps:
      - name: "Check out repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Get version"
        id: version
        run: |
          echo "package=antizapret" >> $GITHUB_ENV
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Если это тег — используем его
            VERSION="${{ github.ref_name }}"
          else
            # Если это push в master — ищем последний тег
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v3.0.0")
          fi
          
          echo "release_version=${VERSION}" >> $GITHUB_ENV
          echo "Version: ${VERSION}"

      - name: "Zip component dir"
        run: |
          zip ${{ env.package }}.zip -r ./ \
            -x "bin/*" \
            -x ".*" \
            -x "*-dev.*" \
            -x ".git/*" \
            -x ".github/*" \
            -x "requirements-dev.txt"

      - name: "Upload zip to release"
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ env.package }}.zip
          asset_name: ${{ env.package }}.zip
          tag: ${{ env.release_version }}
          release_name: "AntiZapret ${{ env.release_version }}"
          overwrite: true
